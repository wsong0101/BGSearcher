{{define "search"}}

<div id="app">
    <div v-if="emptyResult">검색 결과가 없습니다.</div>
    <div class="row">
        <div class="col-sm-6 col-md-4 col-xl-3 d-flex" v-for="data in results">
            <div class="card text-center">
                <div class="card-img-top">
                    <a :href="data.Link" target="blank"><img :src="data.Img" :alt="data.Name"></a>
                </div>
                <div class="card-body">
                    <a :href="data.Link" target="blank"><h5 class="card-title">${data.Name}</h5>
                    </a>
                    <p class="card-text" v-if="data.Name2 != ''">${data.Name2}</p>
                </div>
                <div class="card-footer">
                    <p class="card-text py-2" v-if="!data.SoldOut">${data.Price}</p>
                    <p class="card-text py-2" v-if="data.SoldOut">품절</p>
                </div>
            </div>   
        </div>
    </div>
</div>

<script>
    const router = new VueRouter({ 
        routes, 
        mode:'history' 
    });
    new Vue({
        delimiters: ['${', '}'],
        el: '#app',
        router,
        data: {
            query: "",
            results: [],
            hits: [],
            emptyResult: false
        },
        mounted: function() {
            this.query = this.$route.query.query
            if (this.query != "") {
                this.Search()
            }
        },
        methods: {
            ExtractNumber: function(str) {
                var numbers = str.match(/\d+/g)
                if (numbers == undefined) {
                    return Math.max
                }
                var sum = ""
                numbers.forEach((number) => { sum += number })
                return parseInt(sum)
            },
            Search: function () {
                if (this.query == "") {
                    return
                }

                var self = this
                axios.post("/search", null, {
                    params: {
                        "query": this.query
                    }
                })
                .then(function (resp) {
                    self.results = resp.data

                    if (self.results == null) {
                        self.emptyResult = true
                        return
                    }
                    
                    self.emptyResult = false

                    self.results.sort((l, r) => {
                        if (l.SoldOut && !r.SoldOut) {
                            return 1
                        } else if (!l.SoldOut && r.SoldOut) {
                            return -1
                        }
                        var lPrice = self.ExtractNumber(l.Price)
                        var rPrice = self.ExtractNumber(r.Price)
                        if (lPrice > rPrice) {
                            return 1
                        } else if (lPrice < rPrice) {
                            return -1
                        }
                        return 0
                    })
                })
                .catch(function (error) {
                    console.log(error)
                })
            },
            SearchHits: function(query) {
                this.query = query
                this.Search()
            },
            GetHits: function(event) {
                var self = this
                axios.post("/hits", null, {})
                .then(function (resp) {
                    self.hits = resp.data
                })
                .catch(function (error) {
                    console.log(error)
                })
                
            },
            Refresh: function(event) {
                this.results = []
                this.emptyResult = false
                this.query = ""
            }
        }
    })
</script>

{{end}}